<div id="scroll-video-wrapper-{{ section.id }}" style="position: relative; height: {{ section.settings.section_height }}vh;">
  <video
    id="scroll-video-{{ section.id }}"
    src="https://cdn.shopify.com/videos/c/o/v/7c27f0fbc2654b798d1e20d665a3af3c.mp4"
    playsinline
    preload="auto"
    muted
    style="position: sticky; top: 0; width: 100%; height: auto;"
  ></video>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const video = document.getElementById("scroll-video-{{ section.id }}");
  const wrapper = document.getElementById("scroll-video-wrapper-{{ section.id }}");

  video.pause();
  video.currentTime = 0;

  let scrollMax = wrapper.offsetHeight - window.innerHeight;

  const recalc = () => {
    scrollMax = wrapper.offsetHeight - window.innerHeight;
  };
  window.addEventListener("resize", recalc);

  let last = 0;
  const fps = 30;
  const interval = 1000 / fps;

  const updateVideo = () => {
    if (!video.duration || scrollMax <= 0) return;

    const progress = Math.min(Math.max(window.scrollY / scrollMax, 0), 1);
    video.currentTime = progress * video.duration;
  };

  window.addEventListener("scroll", () => {
    const now = performance.now();
    if (now - last < interval) return;
    last = now;

    requestAnimationFrame(updateVideo);
  });
});
</script>

{% schema %}
{
  "name": "Scroll Video Opti",
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "label": "Hauteur (vh)",
      "min": 100,
      "max": 500,
      "step": 10,
      "default": 200
    }
  ],
  "presets": [
    {
      "name": "Scroll Video Opti"
    }
  ]
}
{% endschema %}