<div 
  id="scroll-seq-wrapper-{{ section.id }}" 
  class="scroll-seq-wrapper"
  style="height:auto;"
>
  <img 
    id="scroll-seq-{{ section.id }}" 
    class="scroll-seq-img"
    alt=""
    decoding="sync"
    fetchpriority="high"
  >
</div>

<style>
.scroll-seq-wrapper {
  position: relative;
  overflow: visible !important;
}

.scroll-seq-img {
  position: sticky;
  top: 0;
  width: 100%;
  height: 100vh;
  object-fit: cover;
  will-change: opacity, transform;
  transform: translateZ(0);
}

@media (max-width: 767px) {
  .scroll-seq-wrapper {
    height: 200vh;
  }

  .scroll-seq-img {
    height: 100vh;
    width: 100vw;
  }
}
</style>

<script>

// Hauteur auto calculée pour éviter le "grand blanc"
function adjustWrapperHeight(wrapper, frameCount) {
  // facteur : plus il est haut, plus l'animation dure longtemps
  const scrollFactor = 2.2; // parfait pour 300–500 frames
  wrapper.style.height = (window.innerHeight * scrollFactor) + "px";
}
adjustWrapperHeight(wrapper, frameCount);
window.addEventListener("resize", () => adjustWrapperHeight(wrapper, frameCount));

document.addEventListener("DOMContentLoaded", () => {

  /* -----------------------------------------------------
     Nombre total de frames
     ----------------------------------------------------- */
  const frameCount = 326;

  /* -----------------------------------------------------
     Générateur d'URL des frames
     ----------------------------------------------------- */
  const frameURL = (i) => {
    const num = String(i).padStart(4, "0");
    return `https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_${num}.jpg`;
  };

  const img = document.getElementById("scroll-seq-{{ section.id }}");
  const wrapper = document.getElementById("scroll-seq-wrapper-{{ section.id }}");

  /* -----------------------------------------------------
     1) Affiche la première image
     ----------------------------------------------------- */
  img.src = frameURL(1);

  /* -----------------------------------------------------
     2) Préchargement "soft" pour fluidité
     ----------------------------------------------------- */
  const preloadFrames = () => {
    for (let i = 1; i <= frameCount; i++) {
      const im = new Image();
      im.src = frameURL(i);
    }
  };

  if ("requestIdleCallback" in window) requestIdleCallback(preloadFrames);
  else setTimeout(preloadFrames, 250);

  /* -----------------------------------------------------
     3) Calcul du scroll
     ----------------------------------------------------- */
  function getScrollMax() {
    return wrapper.offsetHeight - window.innerHeight;
  }

  let scrollMax = getScrollMax();
  window.addEventListener("resize", () => scrollMax = getScrollMax());

  /* -----------------------------------------------------
     4) Animation scroll (45 FPS optimisé)
     ----------------------------------------------------- */
  let last = 0;
  const fps = 45;
  const interval = 1000 / fps;

  function updateFrame() {
    scrollMax = getScrollMax();
    if (scrollMax <= 0) return;

    const progress = Math.min(Math.max(window.scrollY / scrollMax, 0), 1);
    const index = Math.max(1, Math.min(frameCount, Math.round(progress * frameCount)));

    const newSrc = frameURL(index);

    if (img.dataset.src !== newSrc) {
      img.dataset.src = newSrc;
      img.src = newSrc;
    }
  }

  window.addEventListener("scroll", () => {
    const now = performance.now();
    if (now - last < interval) return;
    last = now;
    requestAnimationFrame(updateFrame);
  });

});
</script>

{% schema %}
{
  "name": "Scroll frames)",
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "label": "Hauteur desktop (vh)",
      "min": 100,
      "max": 1000,
      "step": 10,
      "default": 400
    }
  ],
  "presets": [
    {
      "name": "Scroll frame"
    }
  ]
}
{% endschema %}
