<div 
  id="scroll-video-wrapper-{{ section.id }}" 
  class="scroll-video-wrapper"
  style="height: {{ section.settings.section_height }}vh;"
>
  <img 
    id="scroll-seq-{{ section.id }}" 
    class="scroll-video"
    alt=""
    decoding="sync"
    fetchpriority="high"
  >
</div>

<style>
/* ------- Desktop ------- */
.scroll-video-wrapper {
  position: relative;
}

.scroll-video {
  position: sticky;
  top: 0;
  width: 100%;
  height: 100vh;
  object-fit: cover;
  will-change: transform;
  transform: translateZ(0);
}

/* ------- Mobile ------- */
@media (max-width: 767px) {
  .scroll-video-wrapper {
    height: 120vh;
  }

  .scroll-video {
    height: 100vh;
    width: 100vw;
    object-fit: cover;
  }

  .scroll-video-wrapper + * {
    margin-top: 0 !important;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* -----------------------------------------------------
     1) URLs des frames Shopify
     ----------------------------------------------------- */
  const frameURL = (i) => {
    const files = {
      1: "https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_0001.png?v=1764441086",
      2: "https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_0002.png?v=1764441145",
      3: "https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_0003.png?v=1764441201",
      4: "https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_0004.png?v=1764441207",
      5: "https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_0005.png?v=1764441210"
    };
    return files[i] || files[1];
  };

  const frameCount = 5;
  const img = document.getElementById("scroll-seq-{{ section.id }}");
  const wrapper = document.getElementById("scroll-video-wrapper-{{ section.id }}");

  /* -----------------------------------------------------
     2) Préchargement progressif (haute performance)
     ----------------------------------------------------- */
  const preloadFrames = () => {
    for (let i = 1; i <= frameCount; i++) {
      const preloadImg = new Image();
      preloadImg.src = frameURL(i);
    }
  };

  // Précharge quand le navigateur est "idle"
  if ("requestIdleCallback" in window) {
    requestIdleCallback(preloadFrames);
  } else {
    setTimeout(preloadFrames, 200);
  }

  /* -----------------------------------------------------
     3) Affiche la première frame
     ----------------------------------------------------- */
  img.src = frameURL(1);

  function getScrollMax() {
    return wrapper.offsetHeight - window.innerHeight;
  }

  let scrollMax = getScrollMax();
  window.addEventListener("resize", () => {
    scrollMax = getScrollMax();
  });

  /* -----------------------------------------------------
     4) Animation scroll (optimisée)
     ----------------------------------------------------- */
  let last = 0;
  const fps = 45; // un peu plus fluide
  const interval = 1000 / fps;

  function updateFrame() {
    scrollMax = getScrollMax();
    if (scrollMax <= 0) return;

    const progress = Math.min(Math.max(window.scrollY / scrollMax, 0), 1);
    const index = Math.max(1, Math.min(frameCount, Math.round(progress * frameCount)));

    const newSrc = frameURL(index);
    if (img.dataset.src !== newSrc) {
      img.dataset.src = newSrc;
      img.src = newSrc;
    }
  }

  window.addEventListener("scroll", () => {
    const now = performance.now();
    if (now - last < interval) return;
    last = now;
    requestAnimationFrame(updateFrame);
  });

});
</script>

{% schema %}
{
  "name": "Scroll Sequence",
  "settings": [
    {
      "type": "range",
      "id": "section_height",
      "label": "Hauteur desktop (vh)",
      "min": 100,
      "max": 500,
      "step": 10,
      "default": 200
    }
  ],
  "presets": [
    {
      "name": "Scroll Sequence"
    }
  ]
}
{% endschema %}
