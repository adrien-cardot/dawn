<div 
  id="scroll-seq-{{ section.id }}" 
  class="scroll-seq"
>
  <div 
    class="scroll-seq__spacer" 
    data-scroll-spacer 
    data-scroll-area="{{ section.settings.scroll_area }}"
  ></div>

  <canvas class="scroll-seq__canvas"></canvas>
</div>

<style>
.scroll-seq {
  position: relative;
}

.scroll-seq__spacer {
  width: 100%;
}

.scroll-seq__canvas {
  position: sticky;
  top: 0;
  width: 100%;
  height: 100vh;
  display: block;
}

@media (max-width: 767px) {
  .scroll-seq__canvas {
    width: 100vw;
    height: 100vh;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const section = document.getElementById("scroll-seq-{{ section.id }}");
  if (!section) return;

  const canvas = section.querySelector(".scroll-seq__canvas");
  const spacer = section.querySelector("[data-scroll-spacer]");
  const ctx = canvas.getContext("2d");

  /* -----------------------------------------------------
     CONFIG GÉNÉRALE
     ----------------------------------------------------- */

  const originalFrameCount = {{ section.settings.frame_count | default: 315 }};
  
  // On charge UNE IMAGE SUR DEUX
  const frames = [];
  for (let i = 1; i <= originalFrameCount; i += 2) {
    frames.push(i);
  }

  const frameCount = frames.length;

  const frameURL = (i) => {
    const num = String(i).padStart(4, "0");
    return `https://cdn.shopify.com/s/files/1/0985/2066/2341/files/frame_${num}.jpg`;
  };

  /* -----------------------------------------------------
     SCROLL AREA
     ----------------------------------------------------- */
  const scrollArea = parseInt(spacer.getAttribute("data-scroll-area"), 10) || 2200;
  spacer.style.height = (scrollArea + window.innerHeight) + "px";

  const images = [];
  let currentFrame = 0;
  let canvasWidth = 0;
  let canvasHeight = 0;

  /* -----------------------------------------------------
     CANVAS RESPONSIVE
     ----------------------------------------------------- */
  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvasWidth = rect.width;
    canvasHeight = rect.height || window.innerHeight;

    canvas.width = canvasWidth * dpr;
    canvas.height = canvasHeight * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    if (images[currentFrame] && images[currentFrame].complete) {
      drawImage(images[currentFrame]);
    }
  }

  window.addEventListener("resize", resizeCanvas);

  /* -----------------------------------------------------
     LOADER (lazy + soft preload)
     ----------------------------------------------------- */
  function loadImage(index) {
    if (images[index]) return images[index];

    const img = new Image();
    img.src = frameURL(frames[index]);
    images[index] = img;

    img.onload = () => {
      if (index === 0) drawImage(img);
    };

    return img;
  }

  // Précharge les premières frames
  for (let i = 0; i < Math.min(frameCount, 40); i++) {
    loadImage(i);
  }

  /* -----------------------------------------------------
     DESSIN SUR LE CANVAS
     ----------------------------------------------------- */
  function drawImage(img) {
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);

    const scale = Math.max(
      canvasWidth / img.width,
      canvasHeight / img.height
    );

    const w = img.width * scale;
    const h = img.height * scale;
    const x = (canvasWidth - w) / 2;
    const y = (canvasHeight - h) / 2;

    ctx.drawImage(img, x, y, w, h);
  }

  /* -----------------------------------------------------
     SCROLL → INDEX
     ----------------------------------------------------- */
  let lastTime = 0;
  const fps = 45;
  const interval = 1000 / fps;

  function updateFrame() {
    const now = performance.now();
    if (now - lastTime < interval) return;
    lastTime = now;

    const sectionTop = section.offsetTop;
    const scrollY = window.scrollY;
    const relativeScroll = scrollY - sectionTop;

    const clamped = Math.max(0, Math.min(scrollArea, relativeScroll));
    const progress = clamped / scrollArea;

    // map progression 0→1 vers 0→frameCount-1
    const targetFrame = Math.floor(progress * (frameCount - 1));

    if (targetFrame === currentFrame) return;
    currentFrame = targetFrame;

    const img = loadImage(currentFrame);

    if (img.complete) drawImage(img);
    else img.onload = () => { if (currentFrame === targetFrame) drawImage(img); };
  }

  window.addEventListener("scroll", () => requestAnimationFrame(updateFrame));

  // INIT
  resizeCanvas();
});
</script>

{% schema %}
{
  "name": "Scroll frames",
  "settings": [
    {
      "type": "number",
      "id": "frame_count",
      "label": "Nombre total de frames (avant optimisation)",
      "default": 315
    },
    {
      "type": "range",
      "id": "scroll_area",
      "label": "Longueur du scroll (px)",
      "min": 800,
      "max": 4000,
      "step": 100,
      "default": 2000
    }
  ],
  "presets": [
    {
      "name": "Scroll frames optimisé"
    }
  ]
}
{% endschema %}
